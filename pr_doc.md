# Pull Request Doc

## Introduction
This pull request implements the whole VIP-193 and is compatible with Thor v1.3.0

## Major Changes

* Add a new field `VIP193` to `thor.ForkConfig` to make the block height when VIP193 is enabled

* Each master node needs to provide its VRF public key which can be generated by `cmd/vrfkey`. VRF private and public key pair is derived using the master's private key as the random seed. The VRF public key needs to be stored in state and managed by contract `AthorityV2` 

* Add `authority-v2.sol` that defines new methods:
  * `add2`
  * `get2`
  * `native_add2`
  * `native_get2`

* To transit from the current PoA to VIP193
  * Set `VIP193` value
  * Set VRF public keys of the existing master nodes via method `SetVrfPublicKey` or hard code into `var vrfPulicKeyMap` (`./thor/fork_config.go`)

* New constants:
  * `thor.CommitteeSize` - number of endorsements required for producing a new block
  * `thor.CommitteeThresholdFactor` - factor used to compute threshold for determining whether a node is a committee member or not
  * `thor.EpochInterval` - number of rounds (not blocks) each epoch

* package `block`
  * `summary.go` - defines `Summary` struct and related methods
  * `endorsement.go` - defines `Endorsement` struct and related methods
  * `tx_set.go` - defines `TxSet` struct and related methods
  * `header.go` - adds three new fields

* package `vrf` - implements VRF related methods based on package `github.com/algorand/go-algorand/crypto`

* package `consensus`
  * `role.go` - defines methods that validate new data structures
  * `beacon.go` - computes beacon for each epoch

* package `cmd/node`
  * Modified `houseKeeping` to propagate new data structures (`./cmd/node/node.go`)
  * Added `packerLoopVip193` to pack VIP193 enabled blocks (`./cmd/node/packer_loop.go`)
  * Added `endorsorLoop` to endorse new block summaries (`.cmd/node/endorsor_loop.go`)

* `consensus.candidatesCache` has been disabled in functions `validateProposer` in `./consensus/validator.go` and `getAllCandidates` in `./consensus/role.go`. The caching mechanism causes the program to behave abnormally. I haven't figured out why.

## Testing
The fork has been tested on three-node custom network. All nodes are running locally on the same MacBook. One node is set as the bootnode for the other two nodes.